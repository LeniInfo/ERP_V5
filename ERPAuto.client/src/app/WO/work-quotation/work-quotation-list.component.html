<div class="work-quotation-container">
  <div class="container-fluid mt-4 mb-5">

    <div class="card shadow-sm mb-4">
      <div class="card-header bg-secondary text-white d-flex justify-content-between align-items-center">
        <h4 class="mb-0">
          <i class="bi bi-list-ul me-2"></i>Work Quotations List
        </h4>
        <button class="btn btn-primary" (click)="goToAddQuotation()">
          <i class="bi bi-plus-circle me-2"></i>Add New Quotation
        </button>
      </div>

      <div class="card-body">
        <div class="table-responsive">
          <table class="table table-bordered table-hover align-middle">
            <thead class="table-primary">
              <tr>
                <th>S.No</th>
                <th>Quotation #</th>
                <th>Customer</th>
                <th>Date</th>
                <th>Status</th>
                <th class="text-end">Total</th>
                <th class="text-center">Actions</th>
              </tr>
            </thead>

            <tbody>
              <tr *ngIf="isLoadingQuotations">
                <td colspan="7" class="text-center py-4">
                  <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                  </div>
                </td>
              </tr>

              <ng-container *ngFor="let quotation of workQuotations; let i = index">
                <!-- Main Quotation Row -->
                <tr>
                  <td class="text-center">{{ i + 1 }}</td>
                  <td>
                    <strong>{{ quotation.quotationNo }}</strong>
                    <button class="btn btn-sm btn-link p-0 ms-2" 
                            (click)="loadQuotationDetails(quotation.quotationNo)"
                            [title]="isExpanded(quotation.quotationNo) ? 'Collapse' : 'Expand'">
                      <i class="bi" [class.bi-chevron-down]="!isExpanded(quotation.quotationNo)" 
                         [class.bi-chevron-up]="isExpanded(quotation.quotationNo)"></i>
                    </button>
                  </td>
                  <td>
                    <div class="fw-bold">{{ quotation.customer }}</div>
                  </td>
                  <td>{{ formatDate(quotation.quotationDate) }}</td>
                  <td>
                    <span class="badge bg-success">OPEN</span>
                  </td>
                  <td class="text-end fw-bold">{{ quotation.totalValue | number:'1.2-2' }}</td>
                  <td class="text-center">
                    <button class="btn btn-sm btn-primary me-1" (click)="editQuotation(quotation)" title="Edit">
                      <i class="bi bi-pencil-square"></i>
                    </button>
                    <button class="btn btn-sm btn-danger me-1" (click)="deleteQuotation(quotation)" title="Delete">
                      <i class="bi bi-trash"></i>
                    </button>
                    <button class="btn btn-sm btn-info text-white" (click)="viewQuotation(quotation)" title="View Details">
                      <i class="bi bi-eye"></i>
                    </button>
                  </td>
                </tr>

                <!-- Expanded Details Row -->
                <tr *ngIf="isExpanded(quotation.quotationNo)" class="table-light">
                  <td colspan="7" class="p-0">
                    <div class="p-3">
                      <h6 class="mb-3">Quotation Items ({{ getQuotationDetails(quotation.quotationNo).length }})</h6>
                      <div class="table-responsive">
                        <table class="table table-sm table-bordered mb-0">
                          <thead class="table-secondary">
                            <tr>
                              <th>S.No</th>
                              <th>Work Name</th>
                              <th class="text-end">Quantity</th>
                              <th class="text-end">Unit Price</th>
                              <th class="text-end">Discount</th>
                              <th class="text-end">Total Value</th>
                            </tr>
                          </thead>
                          <tbody>
                            <tr *ngFor="let detail of getQuotationDetails(quotation.quotationNo); let j = index">
                              <td class="text-center">{{ j + 1 }}</td>
                              <td>{{ getWorkName(detail) }}</td>
                              <td class="text-end">{{ detail.qty | number:'1.0-0' }}</td>
                              <td class="text-end">{{ detail.unitPrice | number:'1.2-2' }}</td>
                              <td class="text-end">{{ detail.discount | number:'1.2-2' }}</td>
                              <td class="text-end fw-bold">{{ detail.totalValue | number:'1.2-2' }}</td>
                            </tr>
                            <tr *ngIf="getQuotationDetails(quotation.quotationNo).length === 0">
                              <td colspan="6" class="text-center text-muted py-3">
                                No items found for this quotation.
                              </td>
                            </tr>
                          </tbody>
                        </table>
                      </div>
                    </div>
                  </td>
                </tr>
              </ng-container>

              <tr *ngIf="!isLoadingQuotations && workQuotations.length === 0">
                <td colspan="7" class="text-center text-muted py-4">
                  No work quotations found.
                </td>
              </tr>
            </tbody>

          </table>
        </div>
      </div>
    </div>

  </div>

  <!-- View Details Modal -->
  <div class="modal fade" [class.show]="showDetailModal" [style.display]="showDetailModal ? 'block' : 'none'" 
       tabindex="-1" role="dialog" *ngIf="showDetailModal">
    <div class="modal-dialog modal-lg modal-dialog-scrollable" role="document">
      <div class="modal-content">
        <div class="modal-header bg-info text-white">
          <h5 class="modal-title">
            <i class="bi bi-eye me-2"></i>Quotation Details - {{ selectedQuotationForDetail?.quotationNo }}
          </h5>
          <button type="button" class="btn-close btn-close-white" (click)="closeDetailModal()" aria-label="Close"></button>
        </div>
        <div class="modal-body" *ngIf="selectedQuotationForDetail">
          <!-- Header Information -->
          <div class="row mb-4">
            <div class="col-md-6">
              <h6 class="fw-bold mb-3">Quotation Information</h6>
              <table class="table table-sm table-borderless">
                <tr>
                  <td class="fw-bold" style="width: 40%;">Quotation #:</td>
                  <td>{{ selectedQuotationForDetail.quotationNo }}</td>
                </tr>
                <tr>
                  <td class="fw-bold">Date:</td>
                  <td>{{ formatDate(selectedQuotationForDetail.quotationDate) }}</td>
                </tr>
                <tr>
                  <td class="fw-bold">Customer:</td>
                  <td>{{ selectedQuotationForDetail.customer }}</td>
                </tr>
                <tr>
                  <td class="fw-bold">Status:</td>
                  <td><span class="badge bg-success">OPEN</span></td>
                </tr>
              </table>
            </div>
            <div class="col-md-6">
              <h6 class="fw-bold mb-3">Summary</h6>
              <table class="table table-sm table-borderless">
                <tr>
                  <td class="fw-bold" style="width: 40%;">No. of Items:</td>
                  <td>{{ selectedQuotationForDetail.noOfItems }}</td>
                </tr>
                <tr>
                  <td class="fw-bold">Discount:</td>
                  <td>{{ selectedQuotationForDetail.discount | number:'1.2-2' }}</td>
                </tr>
                <tr>
                  <td class="fw-bold">Total Value:</td>
                  <td class="fw-bold text-primary">{{ selectedQuotationForDetail.totalValue | number:'1.2-2' }}</td>
                </tr>
              </table>
            </div>
          </div>

          <!-- Items Table -->
          <h6 class="fw-bold mb-3">Quotation Items</h6>
          <div class="table-responsive">
            <table class="table table-sm table-bordered">
              <thead class="table-secondary">
                <tr>
                  <th>S.No</th>
                  <th>Work Name</th>
                  <th class="text-end">Quantity</th>
                  <th class="text-end">Unit Price</th>
                  <th class="text-end">Discount</th>
                  <th class="text-end">Total Value</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let detail of getQuotationDetails(selectedQuotationForDetail.quotationNo); let j = index">
                  <td class="text-center">{{ j + 1 }}</td>
                  <td>{{ getWorkName(detail) }}</td>
                  <td class="text-end">{{ detail.qty | number:'1.0-0' }}</td>
                  <td class="text-end">{{ detail.unitPrice | number:'1.2-2' }}</td>
                  <td class="text-end">{{ detail.discount | number:'1.2-2' }}</td>
                  <td class="text-end fw-bold">{{ detail.totalValue | number:'1.2-2' }}</td>
                </tr>
                <tr *ngIf="getQuotationDetails(selectedQuotationForDetail.quotationNo).length === 0">
                  <td colspan="6" class="text-center text-muted py-3">
                    No items found for this quotation.
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" (click)="closeDetailModal()">Close</button>
          <button type="button" class="btn btn-primary" (click)="editQuotation(selectedQuotationForDetail)" *ngIf="selectedQuotationForDetail">
            <i class="bi bi-pencil-square me-1"></i>Edit
          </button>
        </div>
      </div>
    </div>
  </div>
  <div class="modal-backdrop fade" [class.show]="showDetailModal" *ngIf="showDetailModal"></div>
</div>
